#!/bin/bash

. /opt/forklift/lib/forklift

# parse args and set values
for i in "${@}"; do

  case $i in
    archive=* )
      BUILD_ID=${i#*=}
      ;;
    previous=* )
      PREVIOUS_BUILD_ID=${i#*=}
      ;;
    token=* )
      WAREHOUSE_TOKEN=${i#*=}
      ;;
    host=* )
      WAREHOUSE_IP=${i#*=}
      ;;
  esac

done

if [[ -n ${PREVIOUS_BUILD_ID} ]]
then
  extract_image
  prep_siphon
  create_ssh_key
  rsync_image
  commit_siphon
else
  gzip_image
  upload_image
fi
